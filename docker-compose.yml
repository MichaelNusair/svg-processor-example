# Docker Compose configuration for SVG Processor
#
# Usage:
#   docker-compose up        # Start all services
#   docker-compose up -d     # Start in background
#   docker-compose down      # Stop all services
#   docker-compose logs -f   # Follow logs
#
# Services:
#   - mongodb: MongoDB database on port 27017
#   - backend: Express API on port 3001
#   - frontend: Vite dev server on port 5173
#
# Note: For development, you may prefer running frontend/backend
# locally with hot reload while using Docker only for MongoDB.

version: '3.8'

services:
  # ==========================================================================
  # MongoDB Database
  # ==========================================================================
  mongodb:
    image: mongo:7
    container_name: svg-processor-mongodb
    restart: unless-stopped
    ports:
      - '27017:27017'
    volumes:
      - mongodb_data:/data/db
    environment:
      # No auth for development; in production, set MONGO_INITDB_ROOT_USERNAME/PASSWORD
      MONGO_INITDB_DATABASE: svg-processor
    healthcheck:
      test: ['CMD', 'mongosh', '--eval', "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - svg-processor-network

  # ==========================================================================
  # Backend API (Express + Node.js)
  # ==========================================================================
  backend:
    build:
      context: .
      dockerfile: apps/backend/Dockerfile
    container_name: svg-processor-backend
    restart: unless-stopped
    ports:
      - '3001:3001'
    environment:
      NODE_ENV: production
      PORT: 3001
      MONGODB_URI: mongodb://mongodb:27017/svg-processor
      CORS_ORIGIN: http://localhost:5173
      UPLOAD_DIR: /app/uploads
    volumes:
      - uploads_data:/app/uploads
    depends_on:
      mongodb:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3001/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - svg-processor-network

  # ==========================================================================
  # Frontend (React + Vite)
  # ==========================================================================
  frontend:
    build:
      context: .
      dockerfile: apps/frontend/Dockerfile
    container_name: svg-processor-frontend
    restart: unless-stopped
    ports:
      - '5173:80'
    depends_on:
      - backend
    networks:
      - svg-processor-network

# ==========================================================================
# Networks
# ==========================================================================
networks:
  svg-processor-network:
    driver: bridge

# ==========================================================================
# Volumes
# ==========================================================================
volumes:
  mongodb_data:
    driver: local
  uploads_data:
    driver: local
